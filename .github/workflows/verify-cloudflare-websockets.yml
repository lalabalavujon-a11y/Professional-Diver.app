name: Verify Cloudflare WebSockets

permissions: read-all

on:
  workflow_dispatch:
    inputs:
      zone_id:
        description: "Cloudflare Zone ID (optional). If omitted, will look up by zone_name."
        required: false
        type: string
      zone_name:
        description: "Cloudflare Zone Name (domain), used for lookup if zone_id omitted"
        required: false
        default: "professionaldiver.app"
        type: string
      ensure_on:
        description: "If true, enable WebSockets when currently off"
        required: false
        default: true
        type: boolean

jobs:
  verify:
    name: Verify WebSockets setting
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Verify Cloudflare WebSockets is ON
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          INPUT_ZONE_ID: ${{ inputs.zone_id }}
          INPUT_ZONE_NAME: ${{ inputs.zone_name }}
          INPUT_ENSURE_ON: ${{ inputs.ensure_on }}
        run: |
          set -euo pipefail

          if [ -z "${CLOUDFLARE_API_TOKEN:-}" ]; then
            echo "‚ùå Missing GitHub secret: CLOUDFLARE_API_TOKEN"
            exit 1
          fi

          ZONE_ID="${INPUT_ZONE_ID:-}"
          ZONE_NAME="${INPUT_ZONE_NAME:-professionaldiver.app}"

          if [ -z "$ZONE_ID" ]; then
            echo "üîç Looking up Zone ID for $ZONE_NAME..."
            ZONE_RESPONSE=$(curl -sS -X GET "https://api.cloudflare.com/client/v4/zones?name=${ZONE_NAME}" \
              -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
              -H "Content-Type: application/json")

            API_SUCCESS=$(echo "$ZONE_RESPONSE" | jq -r '.success // false')
            if [ "$API_SUCCESS" != "true" ]; then
              echo "‚ùå Cloudflare API zone lookup failed:"
              echo "$ZONE_RESPONSE"
              exit 1
            fi

            ZONE_ID=$(echo "$ZONE_RESPONSE" | jq -r '.result[0].id // empty')
            if [ -z "$ZONE_ID" ] || [ "$ZONE_ID" = "null" ]; then
              echo "‚ùå Could not find zone id for $ZONE_NAME"
              exit 1
            fi
          fi

          echo "‚úÖ Zone ID: $ZONE_ID"

          echo "üîé Fetching WebSockets setting..."
          WS_RESPONSE=$(curl -sS -X GET "https://api.cloudflare.com/client/v4/zones/${ZONE_ID}/settings/websockets" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json")

          WS_SUCCESS=$(echo "$WS_RESPONSE" | jq -r '.success // false')
          if [ "$WS_SUCCESS" != "true" ]; then
            echo "‚ùå Cloudflare API websockets setting fetch failed:"
            echo "$WS_RESPONSE"
            exit 1
          fi

          CURRENT_VALUE=$(echo "$WS_RESPONSE" | jq -r '.result.value // empty')
          echo "üìå Current websockets value: ${CURRENT_VALUE}"

          if [ "$CURRENT_VALUE" = "on" ]; then
            echo "‚úÖ WebSockets is ON"
            exit 0
          fi

          if [ "${INPUT_ENSURE_ON}" = "true" ]; then
            echo "‚ö†Ô∏è WebSockets is not ON (value=${CURRENT_VALUE}). Enabling..."
            PATCH_RESPONSE=$(curl -sS -X PATCH "https://api.cloudflare.com/client/v4/zones/${ZONE_ID}/settings/websockets" \
              -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
              -H "Content-Type: application/json" \
              --data '{"value":"on"}')

            PATCH_SUCCESS=$(echo "$PATCH_RESPONSE" | jq -r '.success // false')
            if [ "$PATCH_SUCCESS" != "true" ]; then
              echo "‚ùå Failed to enable WebSockets:"
              echo "$PATCH_RESPONSE"
              exit 1
            fi

            echo "‚úÖ WebSockets enabled successfully"
            exit 0
          fi

          echo "‚ùå WebSockets is not ON (value=${CURRENT_VALUE})"
          exit 1

